(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory)}else{factory(jQuery)}})(function($){var laziestLoader=function(options,callback){var $w=$(window),$elements=this,$loaded=$(),retina=window.devicePixelRatio>1,didScroll=false;options=$.extend(true,{threshold:0,sizePattern:/{{SIZE}}/gi,getSource:getSource,scrollThrottle:250,sizeOffsetPercent:0,setSourceMode:true},options);function getSource($el){var source,slug;var data=$el.data();if(data.pattern&&data.widths&&$.isArray(data.widths)){source=retina?data.patternRetina:data.pattern;source=source||data.pattern;if(typeof data.widths[0]==="object"){slug=function(){var widths=$.map(data.widths,function(val){return val.size});var bestFitWidth=bestFit($el.width(),widths);for(var i=data.widths.length-1;i>=0;i--){if(data.widths[i].size===bestFitWidth){return data.widths[i].slug}}}();source=source.replace(options.sizePattern,slug)}else{source=source.replace(options.sizePattern,bestFit($el.width(),data.widths))}}else{source=retina?data.srcRetina:data.src;source=source||data.src}return source}function bindLoader(){$elements.one("laziestloader",function(){var source;if($(this).data().ratio){setHeight.call(this)}if(options.setSourceMode){source=options.getSource($(this));if(source&&this.getAttribute("src")!==source){this.setAttribute("src",source);if(typeof callback==="function")callback.call(this)}}else{if(typeof callback==="function")callback.call(this)}})}function unbindLoader(){$elements.off("laziestloader")}var bestFit=laziestLoader.bestFit=function(targetWidth,widths){var selectedWidth=widths[widths.length-1],i=widths.length,offset=targetWidth*(options.sizeOffsetPercent/100);widths.sort(function(a,b){return a-b});while(i--){if(targetWidth-offset<=widths[i]){selectedWidth=widths[i]}}return selectedWidth};function laziestloader(){var $inview=$elements.not($loaded).filter(function(){var $el=$(this),threshold=options.threshold;if($el.is(":hidden"))return;var wt=$w.scrollTop(),wb=wt+$w.height(),et=$el.offset().top,eb=et+$el.height();return eb>=wt-threshold&&et<=wb+threshold});$inview.trigger("laziestloader");$loaded.add($inview)}function setHeight(){var $el=$(this),data=$el.data();data.ratio=data.ratio||data.heightMultiplier;if(data.ratio){$el.css({height:Math.round($el.width()*data.ratio)})}}$elements.each(setHeight);bindLoader();$w.scroll(function(){didScroll=true});setInterval(function(){if(didScroll){didScroll=false;laziestloader()}},options.scrollThrottle);$w.resize(function(){$loaded=$();unbindLoader();bindLoader();laziestloader()});laziestloader();return this};$.fn.laziestloader=laziestLoader});